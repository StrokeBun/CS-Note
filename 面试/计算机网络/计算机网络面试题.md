[toc]

### 1. OSI 与 TCP/IP 各层结构与功能

![avatar](../../计算机网络/img/网络分层体系.jpg)

**1. 五层协议**

- **应用层**：为<font color=blue>应用程序</font>提供数据传输服务， 数据单位为<font color=blue>报文</font>，例如 HTTP、FTP等
- **传输层**：为<font color=blue>进程</font>提供数据传输服务，主要有 TCP 和 UDP 协议， TCP 数据单位为<font color=blue>报文段</font>， UDP数据单位为<font color=blue>用户数据报</font>
- **网络层**：为<font color=blue>主机</font>提供数据传输服务，IP 协议位于该层，数据单位为<font color=blue>分组/IP 数据报</font>
- **数据链路层**：为<font color=blue>同一链路的主机</font>提供数据传输服务，数据单位为<font color=blue>帧</font>
- **物理层**：实现传输数据比特流

路由器拥有下面三层协议，主要工作是进行<font color=blue>分组交换</font>

**2. OSI**

- **表示层**：数据压缩、解密、描述，屏蔽主机中数据内部格式不同的问题
- **会话层**：建立、管理会话

该标准并未被使用

**3. TCP/IP**

TCP/IP 将五层协议中的数据链路层和物理层合并为网络接口层



### 2. 三次握手

#### 2.1 三次握手流程

- B 的 TCP 服务器创建传输控制模块 TCB，处于 LISTEN 状态，等待连接请求

- A 的 TCP 客户进程创建 TCB，发送请求报文，SYN = 1, ACK = 0，选择初始序号 seq = x，

  进入 SYN-SENT (同步已发送)状态

- B 同意连接则发送确认报文，SYN = 1，ACK = 1，ack = x + 1，并选择初始序号 seq = y，

  进入 SYN-RCVD (同步收到)状态

- A 收到 B 的确认，发送确认报文，ACK = 1，ack = y + 1，seq = x + 1，进入 ESTABLISHED (已建立连接) 状态

- B 收到 A 的确认，进入 ESTABLISHED 状态

![avatar](../../计算机网络/img/TCP三次握手.jpg)

#### <font color=red>2.2 为什么需要三次握手?</font>

有两个原因：

- **确认客户机与服务器的接收与发送功能正常**

  第一次握手：Server 确认了对方发送正常，自己接收正常

  第二次握手：Client 确认了：自己发送、接收正常，对方发送、接收正常；Server 确认了：对方发送正常，自己接收正常

  第三次握手：确认双方接收与发送正常

- **防止在网络滞留的连接请求报文段到达服务器重新建立连接**



#### 2.3 第 2 次握手传回了 ACK， 为什么还有传回 SYN？

传回 ACK 表明客户端到服务端的通信正常，SYN 用来建立服务端到客户端的通信



#### 2.4 为什么第一次握手不直接选择初始序号为1？

如果每次连接第一次握手的初始序号为 1，假设 A 发送了 1，2，3之后掉线了，重新连接 B，又发送1, 2, 3，将导致包冲突，而选择固定增加的序号，得到重复序号远大于 TTL，防止了该情况的发生



### 3. 四次挥手

#### 3.1 四次挥手流程

- 释放前 A 与 B 都处于 ESTABLISHED状态，A 发送连接释放报文， **FIN = 1**，seq = u，

  进入 FIN-WAIT-1 (终止等待 1)状态

- B 收到报文，发送确认报文，ack = u + 1, B 进入 ClOSE-WAIT (关闭等待)状态，此时 A 到 B 方向 的传输结束， TCP 连接处于 **半关闭**状态

- A 收到来自 B 的确认，进入 FIN-WAIT-2 状态

- B 不再进行发送后，发送释放连接报文，FIN = 1，seq = w，进入 LAST-ACK (最后确认)状态

- A 收到 B 的报文，发送确认报文，ACK = 1，ack = w + 1,  seq = u + 1, 进入 TIME-WAIT (时间等待) 状态，等待 **2MSL** 时间进入 CLOSED 状态； B 收到 A 的确认报文则进入 CLOSED 状态

- 异常情况：如果 B 经过 2MSL 还未收到 A 对 FIN 的确认，将再次发送 FIN，此时 A 已经关闭，会直接发送 RST

![avatar](../../计算机网络/img/TCP四次挥手.jpg)

#### 3.2 为什么需要四次握手?

**为了确保双方都结束了数据传送**，因为 TCP 是**全双工**的，任何一方都可以在数据传送结束后发出连接释放的通知，待对方确认后进入半关闭状态。类似打电话，一方说完，另一方可以继续说



#### 4. TCP 与 UDP 的区别

- UDP 是 无连接的，TCP 是面向连接的
- UDP 支持一对一、一对多、多对一、多对多，TCP 只支持一对一
- 可靠性：TCP 是可靠传输，用于通信可靠场合； UDP 是不可靠传输，常用于通信速度要求高或者视频传输场合
- 传输形式：TCP 面向字节流， UDP 面向报文
- UDP 首部 8 字节，所需时间少，传输效率高；TCP 首部 20 - 60 字节，传输效率低



#### 5. 如何解决 TCP 粘包问题？

其实不存在粘包这个说法，而是 TCP 协议面向字节流，它将收到的应用层数据按字节发送，将会出现

将应用层的包合并发送的情况，只需要在应用层的包中加入 **header** 即可区分