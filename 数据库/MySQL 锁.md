## MySQL 锁

### 1. 锁分类

从对数据操作的粒度可分为

- 表锁：操作时，将锁定整个表
- 行锁：操作时，锁定当前行

从对数据操作的类型分：

- 读锁：共享锁，针对同一数据，多个读操作可以同时进行而不互相影响
- 写锁：排它锁，当前写操作未完成前，阻断其他写锁和读锁



### 2. MySQL 锁

#### 2.1 概述

MySQL 对于不同存储引擎支持不同的锁机制

| 存储引擎 | 表锁 | 行锁 | 页面锁 |
| -------- | ---- | ---- | ------ |
| MyISAM   | 支持 |      |        |
| InnoDB   | 支持 | 支持 |        |
| MEMORY   | 支持 |      |        |
| BDB      | 支持 |      | 支持   |

三种锁的特性

| 锁类型 | 特点                                                         |
| ------ | ------------------------------------------------------------ |
| 表锁   | 偏向 MyISAM 存储引擎，开销小，加锁快，不会出现死锁<br>但锁粒度大，冲突概率高，并发度低 |
| 行锁   | 偏向 InnoDB 存储引擎，开销大，加锁慢，会产生死锁<br>锁粒度小，冲突概率小，并发度高 |
| 页面锁 | 性能介于行锁与表锁之间，会产生死锁                           |



#### 2.2 MyISAM 表锁

MyISAM 存储引擎只支持表锁，在执行 SELECT 语句时，会给涉及的所有表加读锁，对于更新操作则添加写锁

- 读锁：不会阻塞其他用户对该表的读请求，但会阻塞写请求
- 写锁：阻塞其他用户的读写请求

MyISAM 的读写调度是以写优先，因此大量的更新将使查询操作阻塞



#### 2.3 InnoDB 行锁

行锁升级为表锁：如果在查询过程中未使用索引，行锁将会锁住所有数据，类似表锁

间隙锁：当用范围条件请求数据时，InnoDB 会给符合条件的数据加锁；对于符合该范围但是不存在的数据，称为间隙，InnoDB 也会对这些间隙加锁，该机制称为间隙锁