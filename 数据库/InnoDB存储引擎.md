## InnoDB

### 1. 介绍

InnoDB 是默认的存储引擎，以 **页** 作为磁盘和内存交互的基本单位，一次至少读写一个页，默认页大小为 16 KB。

关键特性：

- 插入缓冲
- 双写：刷新脏页时，先复制到 doublewrite buffer，再分两次写到磁盘上；写入崩溃时可以从 doublewrite buffer 获取副本进行恢复
- 自适应哈希索引：为热点页创建哈希索引，提高查询速度
- 异步 IO
- 刷新邻接页：刷新脏页时，检测页所在区的所有页，如果是脏页则一同刷新



### 2.行格式

InnoDB 具有 4 种行格式，分别是 `Compact`、`Redundant`、`Dynamic` 和`Compressed`

#### 2.1 Compact

`Compact` 的行格式如下图所示

<img src="img/compact行格式.jpg" style="zoom:40%">

##### 2.1.1 额外信息

- 变长字段长度：按照列的顺序 **逆序** 存储带变成字段的列实际占用的字节数
- NULL 值列表：使用位图逆序存储各列是否为 NULL
- 记录头信息：记录该行的相关信息

##### 2.1.2 真实数据

真实数据部分存储实际数据，并含有三个隐藏列

- `row_id` ：行 id，非必需，如果未自定义主键，则默认生成 `row_id` 作为隐藏主键
- `transaction_id`：事务 id，MySQL 生成，实现事务
- `roll_pointer` ：回滚指针，MySQL 生成，实现事务回滚 

行溢出：当某一列的数据特别多时，在 `真实数据` 部分只存储一部分数据，把剩余的数据存储在其他页中（存储这些数据的页面称为 `溢出页` ），用一定数量字节存储这些页的地址。

#### 2.2 Dynamic

`Dynamic` 是 InnoDB 默认的行格式，基本与 `Compact` 相同，但在处理行溢出上不存储部分数据，而是将所有数据都存储在溢出页。

<img src="img/dynamic行溢出.jpg" style="zoom:30%"> 

#### 2.3 Compressed

`Compressed` 会采用压缩算法对页面进行压缩，以节省空间，其余与 `Dynamic`相似。

#### 2.4 Redundant

`Redundant` 是 5.0 版本前的默认格式，不多介绍。



### 3. 数据页结构

InnoDB 的数据页结构如下图所示

<img src="img/innodb数据页结构图.jpg" style="zoom:70%" >

页默认大小为 16 KB，分为 7 个部分：

- File Header：文件头，记录页的通用信息，保存了上一个页和下一个页的页编号，形成页链表（B+ 树的叶节点）

- Page Header：表示页的专有信息

- Infimum + Supremum：页中数据形成链表，Infimum、Supremum 分别是链表的头、尾哨兵节点

- User Records：存储数据行，插入新数据则从 Free Space 中分配空间；行的记录头信息中包含 `next_record` 将各数据行组成链表，`delete_mask` 记录该行是否被删除（采用懒删除，如果插入新数据可能复用该行），下图为 User Records 数据存储示意

  <img src="img/页中数据示意.jpg" style="zoom:50%">

- Free Space：页中未使用的部分

- Page Directory：页中 `槽` 的相对位置，InnoDB 会把页中的记录划分为若干个组，每个组的最后一个记录的地址偏移量作为一个 `槽`，查找时先进行二分定位槽，再遍历查找行，加快查找速度

- File Trailer：同步校验部分



### 4. 索引以及使用

#### 4.1  索引的特点

InnoDB 使用 B+ 树索引，并实现聚簇索引，聚簇索引将数据存放在索引的叶子页中，一个表只能有一个聚簇索引（聚簇索引只有 InnoDB 具有，而 MyISAM 将索引和数据分开存储）。

聚簇索引查找过程：

- 定位存储数据页
- 在页中使用二分查找定位 `槽`
- 在槽中进行顺序查找

InnoDB 会自动将主键列将为聚簇索引，没有主键则选择一个唯一的非空索引；二级索引（非聚簇索引，一个索引会建立一棵 B+ 树）在叶节点存放该索引和主键，需要先找到主键值，再通过主键值查找数据（`回表`）。

#### 4.2 使用索引

联合索引将会根据索引出现的顺序给数据排序，例如 `(name, birthday, phone_number)` 将先排序姓名，姓名相同按生日排序，姓名生日都相同根据手机号排序。

索引使用的方法：

- 全值匹配：对索引中的所有列都指定具体值，顺序不影响使用
- 最左匹配：匹配左侧的列即可，例如使用了 `name` 进行查询
- 列前缀匹配：索引列中前缀是排好序的，故使用 `LIKE 'As%'` 将走索引，使用 `LIKE '%As' 或者 LIKE '%As%' `将不走索引
- 范围查询：范围查询只有对联合索引中最左边的列才走索引



### 5. 访问方法

访问方法即 MySQL 指向查询语句的方式

#### 5.1 单表访问方法

单表访问方法分为：

- `const`：通过主键、唯一（UNIQUE）二级索引（如果由多个列组成，则每个列都需要进行等值比较）和一个常数比较查询，不需要回表或者回表查出的行数量为 1

- `ref`：普通（非唯一）二级索引列的等值比较，回表查询出的行数量不固定

- `ref_or_null`：在 `ref` 的基础上额外查询为 NULL 的行

- `range`：范围查询

- `index`：不是最左匹配，但查询的值仅包括索引，在叶节点遍历，不需要进行回表

  ``` sql
  SELECT key_part1, key_part2, key_part3 FROM table_name WHERE key_part2 = 'abc';
  ```

- `all` ：全表扫描

#### 5.2 连接原理

TODO 

