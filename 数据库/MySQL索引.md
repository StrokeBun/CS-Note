## MySQL索引

### 1. 介绍

索引本质上就是帮助数据库获取数据的已排序的数据结构

常见搜索数据结构

- 二叉搜索树：最坏情况会退化为链表，搜索的时间复杂度为 O(n)，效率低下
- 红黑树：搜索的时间复杂度为 O(log n)，但海量数据下树高度过大，搜索过程 IO 频繁，效率较低
- B 树：平衡多路查找树，叶子节点均位于同一层，树高度有所降低，IO 次数减少，并且利用磁盘按块存储的特性( 每次 IO 是按块整块读取的)
- B+ 树：MySQL BTREE 索引底层使用的数据结构，类似 B 树，但叶子节点不存放数据，只保存索引，在高度相等的情况可以放置更多索引；叶子节点存放索引与数据，叶节点用双向链表连接，提升区间搜索的性能

索引的优劣势：

- 优势：降低 IO 次数，提高了查询效率
- 劣势：增加了表占用的空间，提高了更新表的复杂度

MySQL B+ 树的节点大小默认为 16 kB， InnoDB 推荐采用自增整型主键，有序插入可以使 B+ 树拓扑改变次数最少



### 2. 索引结构与分类

#### 2.1 索引结构

MySQL 目前提高了 4 种索引

- BTREE 索引：最常见的索引类型，大部分引擎都支持该索引

- HASH 索引：查找速度快，但只有 Memory 引擎支持
- R-tree 索引：又称空间索引，主要用于地理空间数据，使用较少
- Full-text 索引：全文索引，是 MyISAM 的一个特殊索引类型，主要用于全文索引， InnoDB 在 MySQL 5.6 后支持

| 索引           | InnoDB 引擎    | MyISAM 引擎 | Memory 引擎 |
| -------------- | -------------- | ----------- | ----------- |
| BTREE 索引     | 支持           | 支持        | 支持        |
| HASH 索引      | 不支持         | 不支持      | 支持        |
| R-tree 索引    | 不支持         | 支持        | 不支持      |
| Full-text 索引 | 5.6 版本后支持 | 支持        | 不支持      |

#### 2.2 索引分类

- 单值索引：一个索引只包含一个列，一张表可以有多个单值索引
- 唯一索引：索引的值必须唯一，但可以为 null，且存在多个 
- 联合索引：将多个索引联合，并根据索引顺序进行排序；查找使用了最左侧索引所对的列，才会使用联合索引，因为不保证表中数据按第二个索引排序



### 3. 索引的使用

#### 3.1 避免索引失效

- 全值匹配：对索引中的所有列都指定具体值

- 最左前缀法则：联合索引查询，需要从索引的最左前列开始，并且不跳过中间的列

  ``` mysql
  联合索引为 (name, email, address)
  
  # 索引生效
  select * from user where name = 'bzzb' and email = 'xx@qq.com'
  # 只用了name索引
  select * from user where name = 'bzzb' and address = 'xx'
  # 索引失效
  select * from user where email = 'xx@qq.com' and address = 'xx'
  ```

- 范围查询：范围查询之后的字段的索引失效

- 字段运算：在索引上进行运算，将导致索引失效

- 字符串引号：字符串不加单引号，将导致索引失效

- 尽量使用覆盖索引，避免使用 select * ：覆盖索引是指查询只包含索引列，否则将导致回表查询 (如果是 InnoDB 只要走主键索引，就不会进行回表查询，InnoDB 的主键索引是聚簇索引)，降低效率

- OR 导致索引失效：如果 OR 之前的字段使用了索引，而 OR 之后的字段没有使用索引，将导致索引失效

  ``` mysql
  # 索引失效
  select * from user where name = 'bzzb' or nickname = 'zhibin'
  ```

- 模糊匹配 LIKE 中的字符串以 % 开始，将导致索引失效；可以使用覆盖索引进行改善

- 如果 MySQL 判断全表扫描更快，则不使用索引；例如判断某带索引的字段 IS NOT NULL，但大部分数据非空，则会不走索引

- in 使用索引， not in 不使用索引

  ``` mysql
  # 索引失效
  select * from user where name in {'bzzb', 'zhibin'}
  ```

#### 3.2 单列索引和联合索引

尽量使用联合索引，少使用单列索引

当使用单列索引时，进行查询时，MySQL 会从单列索引中寻找最合适的作为索引，而其他单列索引不会使用